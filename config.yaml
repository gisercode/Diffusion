# ======================================================================================
# 全局数据处理与加载配置文件 (支持三层缺失机制)
# ======================================================================================

# 1. 数据集选择与路径管理 (Dataset Selection & Path Management)
# --------------------------------------------------------------------------------------
dataset:
  name: 'metr_la'  # 可选: 'metr_la', 'pre', 'pm25'

paths:
  raw_data_dir: './data'              # 原始数据根目录
  output_dir: './processed_data'      # 预处理后数据的输出目录

# 2. 离线预处理参数 (Offline Preprocessing Parameters)
# --------------------------------------------------------------------------------------
preprocessing:
  split_ratios: [0.7, 0.1, 0.2]  # 训练集、验证集、测试集的划分比例 (train, val, test)
  use_provided_meanstd: false    # 是否尝试使用数据文件中提供的均值和标准差

# 3. DataLoader 与在线样本生成参数 (DataLoader & Online Sample Generation)
# --------------------------------------------------------------------------------------
dataloader:
  # 3.1 滑动窗口设置 (Sliding Window)
  L_input: 10      # 输入历史序列长度 (T_hist)64
  L_pred: 0        # 预测未来序列长度 (T_pred)，若不需要预测该参数设置为0
  stride: 10       # 指定训练模式下的滑动窗口步长
  # 非训练模式下，若L_pred为0则stride=L_input，否则stride=L_pred

  # 3.2 批处理设置 (Batching)
  batch_size: 4   # 每个批次的样本数量 16

  # 3.2.1 数据集保存选项 (Dataset Saving)
  save_datasets: false # 是否将处理后的训练/验证/测试集（包括掩码）保存到文件

  # =============================================================================
  # 3.3 预设缺失配置 (Preset Masking - 第二层缺失)
  # =============================================================================
  # 说明：预设缺失在 __init__ 中生成，对整个验证集/测试集固定不变。
  #      这一层缺失用于模拟真实场景中的传感器故障、数据丢失等情况。
  #      仅在 val 和 test 模式下生效。
  # -----------------------------------------------------------------------------
  preset_masking:
    seed: 42  # 随机种子，确保预设缺失模式可重复
    
    # 策略1: 全节点掩码 (最高优先级)
    # 随机选择一定比例的节点，将其在整个时间序列内的数据全部标记为缺失。
    full_node:
      enabled: false
      ratio: 0.25  # 掩盖5%的节点
    
    # 策略2: 块状缺失 (中等优先级)
    # 在未被'full_node'掩盖的区域内，制造连续的块状缺失。
    block:
      enabled: true
      length_range: [12, 48]        # 块长度范围（对应1-4小时，假设5分钟采样）
      target_missing_ratio: 0.15     # 块状缺失的目标比例
    
    # 策略3: 随机缺失 (最低优先级)
    # 在未被'full_node'和'block'掩盖的区域内，随机选择单个点进行掩盖。
    random:
      enabled: false
      ratio: 0.15  # 随机缺失5%的数据点

  # =============================================================================
  # 3.4 条件缺失配置 (Conditional Masking - 第三层缺失)
  # =============================================================================
  # 说明：条件缺失在 __getitem__ 中为每个训练样本动态生成。
  #      这一层缺失用于自监督学习，让模型学习重构和预测。
  #      仅在 train 模式下生效。
  # -----------------------------------------------------------------------------
  conditional_masking:
    # 策略1: 全节点掩码 (最高优先级)
    # 随机选择一定比例的节点，将其在历史窗口内的数据全部掩盖。
    full_node:
      enabled: false
      ratio: 0.1  # 掩盖10%的节点
    
    # 策略2: 块状缺失 (中等优先级)
    # 在未被'full_node'掩盖的区域内，制造连续的块状缺失。
    block:
      enabled: true
      length_range: [5, 10]         # 块长度范围
      target_missing_ratio: 0.05    # 块状缺失的目标比例
    
    # 策略3: 随机缺失 (最低优先级)
    # 在未被'full_node'和'block'掩盖的区域内，随机选择单个点进行掩盖。
    random:
      enabled: false
      ratio: 0.05 # 随机掩盖25%的历史数据点


# 4. 模型配置 (Model Configuration)
# --------------------------------------------------------------------------------------
model:
  timeemb: 128            # 时间嵌入维度 128
  featureemb: 16        # 特征嵌入维度 (对应节点嵌入) 16
  is_unconditional: false # 是否为无条件模型 (通常为 false)
  target_strategy: 'hybrid' # 目标策略 (例如 'random', 'prediction' 等，根据模型实际使用情况调整)
  use_guide: true        # 是否使用引导信息 (例如 CDE Coeffs)

# 5. 训练配置 (Training Configuration)
# --------------------------------------------------------------------------------------
train:
  epochs: 1 # 训练的总轮数
  learning_rate: 0.00001 # 降低学习率以提高训练稳定性
  eval_interval: 5 # 每隔多少个 epoch 在测试集上评估一次

# 6. 评估配置 (Evaluation Configuration)
# --------------------------------------------------------------------------------------
evaluation:
  # 是否进行概率性评估。
  # true: 将运行 nsample 次以生成预测分布，计算 CRPS 和预测区间，并保存可视化结果。这会很慢。
  # false: 仅运行 1 次以进行快速点预测，只计算 RMSE/MSE/MAE。
  probabilistic_eval: true
  nsample: 100 # 仅在 probabilistic_eval 为 true 时使用
  
# 7. Diffusion 模型配置 (Diffusion Model Configuration)
# --------------------------------------------------------------------------------------
diffusion:
  channels: 64           # CDE 输出通道数 (或扩散模型内部通道数) 64    diffusion.channels 和 diffusion.nheads的关系是diffusion.channels需要被nheads整除
  diffusion_embedding_dim: 128 # 扩散模型嵌入维度 (根据 diff_models.py 补充)
  num_steps: 100           # 扩散步数 100
  schedule: 'quad'      # Beta 调度策略 ('linear' 或 'quad')
  beta_start: 1.0e-3      # Beta 调度起始值
  beta_end: 0.02         # Beta 调度结束值 (修正：从 0.2 降低以防止数值爆炸)
  is_adp: true            # 是否使用自适应图卷积
  layers: 4               # 扩散模型层数
  nheads: 8               # 多头注意力头数
  proj_t: 16              # 时间投影维度
  rank: 8                # 用于低秩近似的秩 (rank)
  is_cross_t: true
  is_cross_s: true
  tr_ranks: 2

# 8. 结果保存配置 (Results Saving Configuration)
# --------------------------------------------------------------------------------------
results:
  save_final_results: true # true: 保存最终的预测结果; false: 不保存

# 8. 全局设置 (Global Settings)
# --------------------------------------------------------------------------------------
global:
  random_seed: 42  # 随机种子，确保数据集划分和随机掩码生成的可复现性
  device: 'cuda'   # 计算设备选择，'cuda' 或 'cpu'
  num_workers: 4 # DataLoader的子进程数量，0表示不使用子进程
  save_datasets: fasle # 是否保存训练集、验证集和测试集到文件




  # ======================================================================================
# 配置说明
# ======================================================================================
# 
# 三层缺失机制：
# 
# 1. 第一层 - 原始数据缺失 (observed_mask):
#    - 来源：数据本身的零值或 NaN
#    - 生成时机：数据加载时
#    - 作用范围：所有模式 (train/val/test)
#    - 含义：observed_mask[i,j]=1 表示该位置有真实观测值
# 
# 2. 第二层 - 预设缺失 (eval_mask & gt_mask):
#    - 来源：配置中的 preset_masking
#    - 生成时机：Dataset.__init__() 中，对整个数据集生成
#    - 作用范围：仅 val 和 test 模式
#    - 含义：
#      * eval_mask[i,j]=1 表示该位置被预设为缺失（模拟传感器故障）
#      * gt_mask = observed_mask AND NOT eval_mask
#      * gt_mask[i,j]=1 表示该位置既有观测值又不在预设缺失中，可用作评估真值
# 
# 3. 第三层 - 条件缺失 (cond_mask):
#    - 来源：配置中的 conditional_masking
#    - 生成时机：Dataset.__getitem__() 中，为每个样本动态生成
#    - 作用范围：仅 train 模式
#    - 含义：
#      * cond_mask[i,j]=1 表示模型可以看到的数据（条件）
#      * cond_mask[i,j]=0 表示模型需要预测的数据（目标）
#      * 在 val/test 模式下，cond_mask = gt_mask（模型看到所有真值）
# 
# 掩码优先级：
#   对于 preset_masking 和 conditional_masking，都遵循：
#   full_node (最高) > block (中等) > random (最低)
#   后续策略只在前面策略未掩盖的区域内进行。
# 
# ======================================================================================